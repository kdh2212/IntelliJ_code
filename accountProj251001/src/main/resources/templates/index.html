<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>MyWallet - ì§€ì¶œ ê´€ë¦¬</title>
  <style>
    :root {
      --main-color: #00c49a;
      --bg-color: #f8f9fa;
      --text-color: #333;
      --nav-bg: #ffffff;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      margin: 0;
      padding: 0;
    }

    .navbar {
      background-color: var(--nav-bg);
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .nav-links a {
      margin: 0 15px;
      text-decoration: none;
      color: var(--main-color);
      font-weight: bold;
      font-size: 18px;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 15px;
      color: #555;
    }

    .logout-btn {
      background-color: #ff6b6b;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .logout-btn:hover {
      background-color: #e35b5b;
    }

    .container {
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background-color: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    }

    h1 {
      text-align: center;
      color: var(--main-color);
      margin-bottom: 30px;
    }

    .form-group {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 20px;
    }

    .form-group input,
    .form-group select {
      flex: 1;
      min-width: 120px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
    }

    button {
      padding: 10px 20px;
      background-color: var(--main-color);
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #00a97f;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 30px;
    }

    th, td {
      padding: 12px;
      border-bottom: 1px solid #ddd;
      text-align: center;
    }

    th {
      background-color: #f1f1f1;
    }

    #pagination {
      text-align: center;
      margin-top: 20px;
    }

    #pagination button {
      margin: 0 4px;
      padding: 6px 12px;
      font-size: 14px;
      border: 1px solid var(--main-color);
      background-color: #fff;
      color: var(--main-color);
      cursor: pointer;
      border-radius: 4px;
      transition: background-color 0.2s, color 0.2s;
    }

    #pagination button.active {
      background-color: var(--main-color);
      color: #fff;
      font-weight: bold;
    }

    #pagination button:disabled {
      opacity: 0.4;
      cursor: default;
    }

    @media (max-width: 600px) {
      .form-group {
        flex-direction: column;
      }

      .form-group input,
      .form-group select {
        width: 100%;
      }
    }
  </style>
</head>
<body>

<div class="navbar">
  <div class="nav-links">
    <a href="#">ì§€ì¶œ ë‚´ì—­</a>
    <a href="#">ì›”ë³„ í†µê³„</a>
    <a href="#">ë§›ì§‘ ë¦¬ë·°</a>
  </div>
  <div class="user-info">
    <span id="usernameDisplay">ë¡œê·¸ì¸ ì¤‘...</span>
    <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
  </div>
</div>

<div class="container">
  <h1>ğŸ’° MyWallet - ì§€ì¶œ ì…ë ¥</h1>

  <div class="form-group">
    <input type="date" id="date" />
    <input type="number" id="amount" placeholder="ê¸ˆì•¡" />
    <select id="category">
      <option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ</option>
      <option value="ì‹ë¹„">ì‹ë¹„</option>
      <option value="êµí†µë¹„">êµí†µë¹„</option>
      <option value="ì—¬ê°€í™œë™">ì—¬ê°€í™œë™</option>
      <option value="ê¸°íƒ€">ê¸°íƒ€</option>
    </select>
    <input type="text" id="memo" placeholder="ë©”ëª¨ (ì„ íƒ)" />
    <button onclick="submitExpense()">ì§€ì¶œ ì €ì¥</button>
  </div>

  <h2 style="margin-top: 40px; color: #555;">ğŸ“ ì§€ì¶œ ë‚´ì—­</h2>
  <table>
    <thead>
    <tr>
      <th>ë‚ ì§œ</th>
      <th>ê¸ˆì•¡</th>
      <th>ì¹´í…Œê³ ë¦¬</th>
      <th>ë©”ëª¨</th>
      <th>ê´€ë¦¬</th>
    </tr>
    </thead>
    <tbody id="expenseTableBody"></tbody>
  </table>

  <div id="pagination"></div>
</div>

<script>
  let userId = null;
  const ITEMS_PER_PAGE = 5;
  let currentPage = 1;
  let allExpenses = [];

  async function fetchExpenses() {
    const res = await fetch(`/expenses/user/${userId}`);
    allExpenses = await res.json();
    currentPage = 1;
    renderTable();
    renderPagination();
  }

  async function getUserSession() {
    const res = await fetch('/api/session');
    if (res.ok) {
      const data = await res.json();
      userId = data.userId;
      document.getElementById("usernameDisplay").textContent = data.username || "ì‚¬ìš©ì";
      fetchExpenses();
    } else {
      alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
      window.location.href = "/";
    }
  }

  function renderTable() {
    const tbody = document.getElementById("expenseTableBody");
    tbody.innerHTML = "";

    const start = (currentPage - 1) * ITEMS_PER_PAGE;
    const end = start + ITEMS_PER_PAGE;
    const currentItems = allExpenses.slice(start, end);

    currentItems.forEach(expense => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${expense.date}</td>
        <td>${Number(expense.amount).toLocaleString()}ì›</td>
        <td>${expense.category}</td>
        <td>${expense.memo || ""}</td>
        <td>
          <button onclick="editExpense(${expense.id})">ìˆ˜ì •</button>
          <button onclick="deleteExpense(${expense.id})">ì‚­ì œ</button>
        </td>
      `;
      tbody.appendChild(row);
    });
  }

  function renderPagination() {
    const totalPages = Math.ceil(allExpenses.length / ITEMS_PER_PAGE);
    const paginationContainer = document.getElementById("pagination");
    paginationContainer.innerHTML = "";

    const prevBtn = document.createElement("button");
    prevBtn.textContent = "ì´ì „";
    prevBtn.disabled = currentPage === 1;
    prevBtn.onclick = () => {
      currentPage--;
      renderTable();
      renderPagination();
    };
    paginationContainer.appendChild(prevBtn);

    for (let i = 1; i <= totalPages; i++) {
      const pageBtn = document.createElement("button");
      pageBtn.textContent = i;
      if (i === currentPage) pageBtn.classList.add("active");
      pageBtn.onclick = () => {
        currentPage = i;
        renderTable();
        renderPagination();
      };
      paginationContainer.appendChild(pageBtn);
    }

    const nextBtn = document.createElement("button");
    nextBtn.textContent = "ë‹¤ìŒ";
    nextBtn.disabled = currentPage === totalPages;
    nextBtn.onclick = () => {
      currentPage++;
      renderTable();
      renderPagination();
    };
    paginationContainer.appendChild(nextBtn);
  }

  async function submitExpense() {
    const date = document.getElementById("date").value;
    const amount = document.getElementById("amount").value;
    const category = document.getElementById("category").value;
    const memo = document.getElementById("memo").value;

    if (!date || !amount || !category) {
      alert("ë‚ ì§œ, ê¸ˆì•¡, ì¹´í…Œê³ ë¦¬ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }

    const newExpense = { userId, date, amount, category, memo };
    const res = await fetch('/expenses', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(newExpense)
    });

    if (res.ok) {
      alert("ì§€ì¶œì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
      resetForm();
      fetchExpenses();
    } else {
      alert("ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    }
  }

  function editExpense(id) {
    const expense = allExpenses.find(e => e.id === id);
    if (!expense) return;

    document.getElementById("date").value = expense.date;
    document.getElementById("amount").value = expense.amount;
    document.getElementById("category").value = expense.category;
    document.getElementById("memo").value = expense.memo || "";

    const saveBtn = document.querySelector(".form-group button");
    saveBtn.textContent = "ìˆ˜ì • ì €ì¥";
    saveBtn.onclick = () => updateExpense(id);
  }

  async function updateExpense(id) {
    const date = document.getElementById("date").value;
    const amount = document.getElementById("amount").value;
    const category = document.getElementById("category").value;
    const memo = document.getElementById("memo").value;

    if (!date || !amount || !category) {
      alert("ë‚ ì§œ, ê¸ˆì•¡, ì¹´í…Œê³ ë¦¬ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }

    const updatedExpense = { userId, date, amount, category, memo };
    const res = await fetch(`/expenses/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(updatedExpense)
    });

    if (res.ok) {
      alert("ì§€ì¶œì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!");
      resetForm();
      fetchExpenses();
    } else {
      alert("ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    }
  }

  async function deleteExpense(id) {
    if (!confirm("ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    const res = await fetch(`/expenses/${id}`, { method: 'DELETE' });
    if (res.ok) {
      alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
      fetchExpenses();
    } else {
      alert("ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    }
  }

  function resetForm() {
    document.getElementById("date").value = "";
    document.getElementById("amount").value = "";
    document.getElementById("category").value = "";
    document.getElementById("memo").value = "";

    const saveBtn = document.querySelector(".form-group button");
    saveBtn.textContent = "ì§€ì¶œ ì €ì¥";
    saveBtn.onclick = submitExpense;
  }

  async function logout() {
    if (!confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    const res = await fetch('/logout', { method: 'POST' });
    if (res.ok) {
      alert("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.");
      window.location.href = "/";
    } else {
      alert("ë¡œê·¸ì•„ì›ƒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    }
  }

  fetchExpenses();
  getUserSession();
</script>

</body>
</html>
